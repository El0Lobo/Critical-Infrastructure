#!/usr/bin/env python3
"""
Code Formatter - Format code with ruff
Platform-agnostic formatter for Windows, Linux, and macOS
"""
import os
import sys
from pathlib import Path

# Add bin directory to path for shared module
sys.path.insert(0, str(Path(__file__).parent))

from _shared import (
    check_virtualenv,
    console,
    get_project_root,
    get_venv_python,
    print_error,
    print_header,
    print_info,
    print_step,
    print_success,
    run_command,
)


def has_ruff() -> bool:
    """Check if ruff is installed"""
    venv_python = get_venv_python()
    result = run_command([str(venv_python), "-c", "import ruff"], check=False, capture_output=True)
    return result.returncode == 0


def format_code():
    """Format code with ruff"""
    venv_python = get_venv_python()
    errors = []

    print_header("Formatting Code", "Using ruff formatter and linter")

    # Step 1: Ruff formatter (replaces black)
    print_step(1, 2, "Running ruff formatter...")
    cmd = [str(venv_python), "-m", "ruff", "format", "app/"]
    result = run_command(cmd, check=False)

    if result.returncode == 0:
        print_success("Code formatted with ruff")
    else:
        print_error("Ruff formatting failed")
        errors.append("ruff format")
    console.print()

    # Step 2: Ruff linter with auto-fixes (import sorting, etc.)
    print_step(2, 2, "Running ruff linter with auto-fixes...")
    cmd = [str(venv_python), "-m", "ruff", "check", "--fix", "app/"]
    result = run_command(cmd, check=False)

    if result.returncode == 0:
        print_success("Linting complete with ruff")
    else:
        # Ruff might return non-zero even on success if it fixed things
        print_info("Ruff applied fixes")
    console.print()

    # Summary
    console.print()
    if not errors:
        print_success("All formatting complete!")
        return 0
    else:
        print_error(f"Formatting completed with issues: {', '.join(errors)}")
        return 1


def main():
    """Main function"""
    try:
        # Change to project root
        os.chdir(get_project_root())

        # Check virtualenv
        if not check_virtualenv():
            sys.exit(1)

        # Check if ruff is installed
        if not has_ruff():
            print_error("Ruff is not installed")
            print_info("Install with: pip install -r requirements-dev.txt")
            sys.exit(1)

        # Format code
        exit_code = format_code()
        sys.exit(exit_code)

    except KeyboardInterrupt:
        console.print()
        print_error("Formatting interrupted by user")
        sys.exit(130)
    except Exception as e:
        print_error(f"\nUnexpected error: {e}")
        import traceback

        traceback.print_exc()
        sys.exit(1)


if __name__ == "__main__":
    main()
