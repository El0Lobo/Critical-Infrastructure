#!/usr/bin/env python3
"""
CI Simulator - Run all CI checks locally
Platform-agnostic CI simulation for Windows, Linux, and macOS
"""
import os
import sys
from pathlib import Path

# Add bin directory to path for shared module
sys.path.insert(0, str(Path(__file__).parent))

from _shared import (
    check_virtualenv,
    console,
    create_status_table,
    get_project_root,
    get_venv_python,
    print_error,
    print_header,
    print_info,
    print_section,
    print_step,
    print_success,
    run_command,
    show_banner,
    show_demoscene_intro,
)


def run_ci_checks() -> dict:
    """Run all CI checks and return results"""
    venv_python = get_venv_python()
    results = {}

    # Show fancy intro
    show_demoscene_intro()

    print_header("CI Pipeline Simulation", "Running the same checks as GitHub Actions")
    console.print()

    # Check 1: Code formatting
    print_step(1, 5, "Checking code format (ruff)...")
    cmd = [str(venv_python), "-m", "ruff", "format", "--check", "app/"]
    result = run_command(cmd, check=False)
    results["formatting"] = result.returncode == 0

    if results["formatting"]:
        print_success("Code formatting check passed")
    else:
        print_error("Code formatting check failed")
    console.print()

    # Check 2: Linting
    print_step(2, 5, "Linting code (ruff)...")
    cmd = [str(venv_python), "-m", "ruff", "check", "app/"]
    result = run_command(cmd, check=False)
    results["linting"] = result.returncode == 0

    if results["linting"]:
        print_success("Linting check passed")
    else:
        print_error("Linting check failed")
    console.print()

    # Check 3: Type checking
    print_step(3, 5, "Type checking (mypy)...")
    cmd = [str(venv_python), "-m", "mypy", "app/"]
    result = run_command(cmd, check=False)
    results["type-checking"] = result.returncode == 0

    if results["type-checking"]:
        print_success("Type checking passed")
    else:
        print_info("Type checking has issues (not blocking for now)")
    console.print()

    # Check 4: Security scan
    print_step(4, 5, "Security scan (bandit)...")
    cmd = [str(venv_python), "-m", "bandit", "-r", "app/", "-c", "pyproject.toml"]
    result = run_command(cmd, check=False)
    results["security"] = result.returncode == 0

    if results["security"]:
        print_success("Security scan passed")
    else:
        print_info("Security scan found issues (review recommended)")
    console.print()

    # Check 5: Tests
    print_step(5, 5, "Running tests (pytest)...")
    cmd = [str(venv_python), "-m", "pytest", "--tb=short"]
    result = run_command(cmd, check=False)
    results["tests"] = result.returncode == 0

    if results["tests"]:
        print_success("All tests passed")
    else:
        print_error("Some tests failed")
    console.print()

    return results


def print_ci_summary(results: dict):
    """Print CI results summary"""
    print_section("CI Pipeline Results")

    # Create and display results table
    table = create_status_table(results)
    console.print(table)
    console.print()

    # Count passes
    passed = sum(1 for v in results.values() if v)
    total = len(results)
    percentage = int((passed / total) * 100)

    # Print overall result
    if all(results.values()):
        show_banner(f"All CI checks passed! ({passed}/{total}) - {percentage}%", style="green")
        print_info("Your changes are ready to push!")
        return 0
    else:
        show_banner(f"Some CI checks failed ({passed}/{total} passed) - {percentage}%", style="yellow")
        print_info("Fix the failing checks before pushing")
        return 1


def main():
    """Main function"""
    try:
        # Change to project root
        os.chdir(get_project_root())

        # Check virtualenv
        if not check_virtualenv():
            sys.exit(1)

        # Run CI checks (they'll fail gracefully if deps are missing)
        results = run_ci_checks()

        # Print summary
        exit_code = print_ci_summary(results)
        sys.exit(exit_code)

    except KeyboardInterrupt:
        console.print()
        print_error("CI checks interrupted by user")
        sys.exit(130)
    except Exception as e:
        print_error(f"\nUnexpected error: {e}")
        import traceback

        traceback.print_exc()
        sys.exit(1)


if __name__ == "__main__":
    main()
