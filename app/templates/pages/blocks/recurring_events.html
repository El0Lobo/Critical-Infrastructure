{% load inline_edit i18n %}
{% if props.style_font_faces %}
  {% for css in props.style_font_faces %}
    <style>{{ css|safe }}</style>
  {% endfor %}
{% endif %}
<section class="page-block page-block--recurring-events" {% if props.style_inline %}style="{{ props.style_inline }}"{% endif %}>
  <div class="page-block__container">
    {% if props.title %}
      <div class="page-block__header">
        {% with style=props.style_inline_targets.title %}
          <h2 {% if style %}style="{{ style }}"{% endif %} {% inline_attrs block 'title' %}>{{ props.title|inline_richtext }}</h2>
        {% endwith %}
        {% if props.subtitle %}
          {% with style=props.style_inline_targets.subtitle %}
            <p {% if style %}style="{{ style }}"{% endif %} {% inline_attrs block 'subtitle' %}>{{ props.subtitle|inline_richtext }}</p>
          {% endwith %}
        {% endif %}
      </div>
    {% endif %}

    <div class="page-recurring">
      {% for event in series %}
        <article class="page-recurring__card">
          {% if event.hero_image %}
            <div class="page-recurring__image" style="background-image:url('{{ event.hero_image }}');"></div>
          {% endif %}
          <div class="page-recurring__body">
            <div class="page-recurring__meta">
              {% if event.recurrence.description %}
                <span class="badge">{{ event.recurrence.description }}</span>
              {% endif %}
              {% if event.effective_start %}
                <span class="page-recurring__next">{% trans "Next" %}: {{ event.effective_start|date:"M j · H:i" }}</span>
              {% endif %}
            </div>
            <h3 class="page-recurring__title">{{ event.title }}</h3>
            {% if event.teaser %}
              <p class="page-recurring__teaser">{{ event.teaser }}</p>
            {% endif %}
            <div class="page-recurring__actions">
              <button type="button" class="btn btn-ghost" data-modal-open="recurring-{{ event.slug }}">{% trans "View series" %}</button>
              {% if event.url %}
                <a class="btn btn-outline-secondary" href="{{ event.url }}">{% trans "Event page" %}</a>
              {% endif %}
            </div>
          </div>
        </article>

        <div class="modal-overlay" id="recurring-{{ event.slug }}" hidden>
          <div class="modal-card dark" role="dialog" aria-modal="true" aria-labelledby="recurring-{{ event.slug }}-title">
            <header class="modal-header">
              <div>
                <h2 id="recurring-{{ event.slug }}-title">{{ event.title }}</h2>
                {% if event.recurrence.description %}
                  <p class="muted">{{ event.recurrence.description }}</p>
                {% endif %}
              </div>
              <button type="button" class="btn btn-xs btn-outline-secondary" data-modal-close>{% trans "Close" %}</button>
            </header>
            <div class="modal-form">
              {% if event.description %}
                <div class="content">{{ event.description|safe }}</div>
              {% endif %}
              <div class="page-recurring__schedule">
                <h4>{% trans "Upcoming dates" %}</h4>
                <ul>
                  {% for occ in event.occurrences %}
                    <li>
                      <time datetime="{{ occ.start }}">{{ occ.start|date:"D, M j · H:i" }}</time>
                      {% if occ.is_override %}<span class="badge">{% trans "Special" %}</span>{% endif %}
                      {% if occ.is_past %}<span class="badge">{% trans "Past" %}</span>{% endif %}
                    </li>
                  {% endfor %}
                </ul>
              </div>
              {% if event.url %}
                <div class="modal-actions">
                  <a class="btn btn-primary" href="{{ event.url }}">{% trans "Full event details" %}</a>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      {% empty %}
        <p class="muted">{% trans "No recurring series yet." %}</p>
      {% endfor %}
    </div>
  </div>
</section>
